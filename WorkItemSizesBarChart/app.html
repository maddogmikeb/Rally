<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- Copyright (c) 2012  Rally Software Development Corp.  All rights reserved -->
<html>
<head>
    <title>FeatureThroughput</title>
    <meta name="Name" content="App: PortfolioItemThroughput" />
    <meta name="Version" content="2012.08.27" />
    <meta name="Vendor" content="Rally Software" />
    <script type="text/javascript" src="/apps/1.29/sdk.js?debug=false"></script>

    <style>
        .AxisTickLabels {
            height: 10px;
            -webkit-transform: rotate(315deg);
            -moz-transform: rotate(315deg);
            -o-transform: rotate(315deg);
            writing-mode: lr-tb;
        }
    </style>

    <script type="text/javascript">

        HTMLElement.prototype.alpha = function (a) {
            current_color = getComputedStyle(this).getPropertyValue("background-color");
            match = /rgba?\((\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(,\s*\d+[\.\d+]*)*\)/g.exec(current_color)
            a = a > 1 ? (a / 100) : a;
            this.style.backgroundColor = "rgba(" + [match[1], match[2], match[3], a].join(',') + ")";
        }

        function PortfolioItemThroughput() {
            var that = this;
            this.display = function (element) {
                var DEFAULT_NUM_WEEKS = 12 - 1;

                var rallyDataSource = null;
                var storiesTable = null;

                var recentResults = null;
                var currentSeries = null;
                var currentNumWeeks = null;

                var weeks = {};

                function isNumeric(n) {
                    return !isNaN(parseFloat(n)) && isFinite(n);
                }

                function getSunday(date) {
                    var day = date.getDay() || 7;
                    if (day !== 1)
                        date.setHours(-24 * (day - 1));
                    date.setHours(-24);
                    date.setHours(0, 0, 0, 0); // set to midnight
                    return date;
                }

                function dateToYMD(date) {
                    var d = date.getDate();
                    var m = date.getMonth() + 1;
                    var y = date.getFullYear();
                    //return y + '-' + (m <= 9 ? '0' + m : m) + '-' + (d <= 9 ? '0' + d : d);
                    return (d <= 9 ? '0' + d : d) + '/' + (m <= 9 ? '0' + m : m);
                }

                function convertUTCDateToLocalDate(date) {
                    var newDate = new Date(date.getTime() + date.getTimezoneOffset() * 60 * 1000);
                    var offset = date.getTimezoneOffset() / 60;
                    var hours = date.getHours();
                    newDate.setHours(hours - offset);
                    return newDate;
                }

                function getKeyFromRecord(record) {
                    //var d = rally.sdk.util.DateTime.fromIsoString(record.AcceptedDate);
                    var d = new Date(record.AcceptedDate);
                    return getKeyFromDate(d);
                }

                function getKeyFromDate(theDate) {
                    return dateToYMD(getSunday(theDate));
                }

                function getSeries(item) {
                    var est = item.PlanEstimate;
                    if (!isNumeric(est)) return "None";
                    if (est <= 0) return "None";
                    if (est <= 3) return "X-Small";
                    if (est <= 5) return "Small";
                    if (est <= 11) return "Medium";
                    if (est <= 19) return "Large";
                    return "X-Large";
                }

                function getSeriesNames() {
                    return ["None", "X-Small", "Small", "Medium", "Large", "X-Large"];
                }

                function collectResults(results) {
                    var series = {};

                    var p = {};

                    dojo.forEach(results.completedItems, function (item) {
                        var seriesName = getSeries(item);
                        item.Series = seriesName;
                        var seriesVals = null;
                        if (series[seriesName]) {
                            seriesVals = series[seriesName];
                        } else {
                            seriesVals = [];
                            series[seriesName] = seriesVals;
                        }
                        if (!series[seriesName].hasOwnProperty("Total")) {
                            series[seriesName].Total = 0;
                        }

                        var key = getKeyFromRecord(item);
                        item.SeriesKey = key;

                        if (!p.hasOwnProperty(key)) {
                            p[key] = 0;
                        }

                        var found = false;
                        dojo.forEach(seriesVals, function (val) {
                            if (val[0] == key) {
                                val[1] += 1;
                                found = true;
                            }
                        });
                        if (!found) {
                            var newVal = [key, 1];
                            seriesVals.push(newVal);
                        }

                        series[seriesName].Total += 1;
                        p[key] += 1;

                        item.FormattedIDLink = new rally.sdk.ui.basic.Link({ "item": item });
                        item.AcceptedDate = convertUTCDateToLocalDate(rally.sdk.util.DateTime.fromIsoString(item.AcceptedDate)).toString();
                    });

                    //var seriesnames = getSeriesNames();
                    //for (var i in seriesnames) {
                    //    try {
                    //        var seriesName = seriesnames[i];
                    //        console.log(seriesName + " total: " + series[seriesName].Total);
                    //        for (var j in series[seriesName]) {
                    //            var val = series[seriesName][j];
                    //            console.log(seriesName + " " + val[0] + " " + val[1]);
                    //        }
                    //    } catch (e) {

                    //    }
                    //}
                    
                    recentResults = results;
                    currentSeries = series;
                    renderChart(series, p);
                }

                function renderChart(data, p) {
                    var chart = new EJSC.Chart("chart",
                        {
                            show_legend: false,
                            height: "60%",
                            width: "100%",
                            show_titlebar: false,
                            auto_resize: true,
                            allow_mouse_wheel_zoom: false,
                            axis_bottom: {
                                label_class: "AxisTickLabels",
                                caption: ""
                            },
                            axis_left: {
                                caption: ""
                            }
                        });

                    var startDate = rally.sdk.util.DateTime.add(getSunday(new Date()), "week", (0 - currentNumWeeks));
                    for (var idx = 0; idx < currentNumWeeks; idx++) {
                        var binKey = getKeyFromDate(startDate);
                        //console.log("renderChart - Start: " + startDate);

                        chart.axis_bottom.addBin(binKey);
                        startDate = rally.sdk.util.DateTime.add(startDate, "week", 1);
                    }

                    var sum = 0;
                    var count = 0;
                    for (var i in p) {
                        //console.log("Total for " + i + ": " + p[i]);
                        sum += p[i];
                        count++;
                    }
                    var average = sum / count;
                    var averages = [];
                    for (var i in p) {
                        averages.push([i, average]);
                    }

                    chart.setTitle("Average: " + average.toFixed(2));
                    chart.showTitlebar();

                    var averageLine = new EJSC.LineSeries(
                        new EJSC.ArrayDataHandler(averages), { title: "Average" }
                    );
                    chart.addSeries(averageLine);

                    var container = new EJSC.StackedBarSeries({ title: "container", autosort: true }, false);
                    container.onShowHint = function (point, series, chart, hint_string) {
                        var weekLabel = point.x;
                        if (dojo.isString(weekLabel) === false) {
                            weekLabel = chart.axis_bottom.__ticks[weekLabel - 1].l;
                        }
                        var total = 0;
                        var series = chart.__series[1].__series;
                        for (var j in series) {
                            var item = series[j];
                            for (var a in item.__dataHandler.__array) {
                                var aitem = item.__dataHandler.__array[a];
                                if (aitem[0] == weekLabel) {
                                    total += aitem[1];
                                }
                            }
                        }
                        return "<span style='font-size: 12pt'>[series_title] = <b>[y]</b></span><br/><br/><b>Total: " + total + "</b>";
                    };
                    chart.addSeries(container);

                    var seriesnames = getSeriesNames();
                    for (var i in seriesnames) {
                        var item = seriesnames[i];
                        if (data.hasOwnProperty(item)) {
                            var dh = new EJSC.ArrayDataHandler(data[item]);
                            var series = container.addSeries(new EJSC.BarSeries(dh, { title: item, autosort: true }), false);
                            var es = document.getElementsByClassName(item);
                            for (var i = 0; i < es.length; i++) {
                                if (es[i]) {
                                    es[i].style.backgroundColor = series.color;
                                    es[i].alpha(20);
                                }
                            }
                        }
                    }

                    chart.onAfterSelectPoint = function (point, series, chart, hintElem, type) {
                        if (type == 'select') {
                            var weekLabel = point.x;
                            if (dojo.isString(weekLabel) === false) {
                                weekLabel = chart.axis_bottom.__ticks[weekLabel - 1].l;
                            }
                            renderTable(series.title, weekLabel);
                        }
                    };
                }

                function renderTable(series, week) {
                    document.getElementById("stories").innerHTML = "";

                    if (recentResults) {
                        var selectedRecords = dojo.filter(recentResults.completedItems, function (item) {
                            return item.Series == series && item.SeriesKey == week;
                        });
                        var tableConfig = {
                            columns: [
                                { key: "FormattedIDLink", header: "Formatted ID" },
                                { key: "Name", header: "Name" },
                                { key: "Project.Name", header: "Project" },
                                { key: "PlanEstimate", header: "Plan Estimate" },
                                { key: "AcceptedDate", header: "Accepted Date" }
                            ],
                            items: selectedRecords
                        };

                        if (storiesTable) {
                            storiesTable.destroy();
                        }
                        storiesTable = new rally.sdk.ui.Table(tableConfig);
                        storiesTable.display("stories");

                    } else {
                        console.log("WHOOPS.  There should be some results.");
                    }
                }

                function loadData(numWeeks) {
                    var startDate = getSunday(rally.sdk.util.DateTime.add(getSunday(convertUTCDateToLocalDate(new Date())), "week", (0 - numWeeks)));
                    var endDate = getSunday(convertUTCDateToLocalDate(new Date()));

                    var queryConfig = {
                        key: 'completedItems',
                        type: 'hierarchicalrequirement',
                        fetch: 'Parent,AcceptedDate,PlanEstimate,Project,Name,FormattedID',
                        order: 'AcceptedDate',
                        query: '((AcceptedDate >= "' + rally.sdk.util.DateTime.format(startDate, 'yyyy-MM-dd') + '") And (AcceptedDate < "' + rally.sdk.util.DateTime.format(endDate, 'yyyy-MM-dd') + '"))'
                    };
                    rallyDataSource.findAll(queryConfig, collectResults);
                }

                function onLoad() {
                    document.getElementById("chart").innerHTML = "Loading chart...";

                    rallyDataSource = new rally.sdk.data.RallyDataSource(
                                            '__WORKSPACE_OID__',
                                               '__PROJECT_OID__',
                                               '__PROJECT_SCOPING_UP__',
                                               '__PROJECT_SCOPING_DOWN__');

                    rallyDataSource.setApiVersion('1.37');

                    currentNumWeeks = DEFAULT_NUM_WEEKS;
                    loadData(currentNumWeeks)
                }

                rally.addOnLoad(onLoad);
            };
        }

        function onLoad() {
            var featureThroughput = new PortfolioItemThroughput();
            featureThroughput.display(dojo.body());
            var appHeader = document.getElementById("appHeader");
            if (appHeader) {
                appHeader.parentNode.removeChild(appHeader);
            }
        }

        rally.addOnLoad(onLoad);

    </script>
</head>
<body>
    <div id="chart" style="height: 400px; width: 100%"></div>
    <div id="stories"></div>
    <div>
        <table style="width: 200px">
            <thead style="font-weight: bold;">
                <tr>
                    <td>
                        Name
                    </td>
                    <td>
                        Planned Estimated
                    </td>
                </tr>
            </thead>
            <tbody style="text-align: center;">
                <tr class="None">
                    <td>
                        None
                    </td>
                    <td>
                        0 or Not set
                    </td>
                </tr>
                <tr class="X-Small">
                    <td>
                        X-Small
                    </td>
                    <td>
                        0 > X <= 3
                    </td>
                </tr>
                <tr class="Small">
                    <td>
                        Small
                    </td>
                    <td>
                        3 > X <= 5
                    </td>
                </tr>
                <tr class="Medium">
                    <td>
                        Medium
                    </td>
                    <td>
                        5 > X <= 11
                    </td>
                </tr>
                <tr class="Large">
                    <td>
                        Large
                    </td>
                    <td>
                        11 > X <= 19
                    </td>
                </tr>
                <tr class="X-Large">
                    <td>
                        X-Large
                    </td>
                    <td>
                        19 > X
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</body>
</html>
