<script src="/apps/1.26/sdk.js"></script>
<script src="//code.jquery.com/jquery-2.1.4.min.js"></script>

<style>
    body {
        max-width: 100%;
    }

    .btn {
        background: rgb(0, 169, 224);
        background-image: -webkit-linear-gradient(top, rgb(0, 169, 224), rgb(0, 169, 224));
        background-image: -moz-linear-gradient(top, rgb(0, 169, 224), rgb(0, 169, 224));
        background-image: -ms-linear-gradient(top, rgb(0, 169, 224), rgb(0, 169, 224));
        background-image: -o-linear-gradient(top, rgb(0, 169, 224), rgb(0, 169, 224));
        background-image: linear-gradient(to bottom, rgb(0, 169, 224), rgb(0, 169, 224));
        -webkit-border-radius: 3;
        -moz-border-radius: 3;
        border-radius: 3px;
        color: #ffffff;
        padding: 5px 10px 5px 10px;
        text-decoration: none;
        margin-right: 10px;
    }

        .btn:hover {
            background: #3cb0fd;
            background-image: -webkit-linear-gradient(top, #3cb0fd, #3498db);
            background-image: -moz-linear-gradient(top, #3cb0fd, #3498db);
            background-image: -ms-linear-gradient(top, #3cb0fd, #3498db);
            background-image: -o-linear-gradient(top, #3cb0fd, #3498db);
            background-image: linear-gradient(to bottom, #3cb0fd, #3498db);
            text-decoration: none;
        }

        .btn:link {
            color: white;
        }

        .btn:visited {
            color: white;
        }

    .div-table {
        display: table;
        background-color: #eee;
        border: 1px solid #666666;
        border-spacing: 5px; /*cellspacing:poor IE support for  this*/
    }

    .div-table-row {
        display: table-row;
        width: 100%;
        clear: both;
    }

    .div-table-col {
        float: left; /*fix for  buggy browsers*/
        display: table-column;
        background-color: #ccc;
        width: 9%;
        min-height: 100px;
        display: inline-block;
        padding: 0px;
        border: 1px solid #aaaaaa;
    }

    .div-table-col-tally {
        float: left; /*fix for  buggy browsers*/
        display: table-column;
        background-color: #ccc;
        width: 9%;
        min-height: 30px;
        display: inline-block;
        padding: 0px;
        margin-left: 1px;
        font: 11px arial,tahoma,helvetica,sans-serif;
    }

        .div-table-col-tally.weekend {
            display: inline;
            visibility: hidden;
            width: 20px !important;
            text-overflow: clip;
            text-indent: 100%;
            overflow: hidden;
        }

        .div-table-col-tally.highlight > * {
            visibility: hidden;
            display: inline;
        }

        .div-table-col-tally > * > .data {
            width: 100%;
        }

    #lunch > .div-table-col {
        min-height: 50px;
    }

    .col {
        width: 9%;
        min-width: 20px;
    }

    .div-table-col-header {
        float: left; /*fix for  buggy browsers*/
        display: table-column;
        background-color: #ccc;
        height: 22px;
        padding: 0px;
        border: 1px solid #aaaaaa;
    }

    .div-table-col-holiday {
        float: left; /*fix for  buggy browsers*/
        display: table-column;
        width: 20px;
        background-color: red;
        min-height: 300px;
        display: inline-block;
        padding: 0px;
        border: 1px solid #aaaaaa;
    }

    .div-table-col-holiday-header {
        float: left; /*fix for  buggy browsers*/
        display: table-column;
        width: 20px;
        background-color: red;
        height: 22px;
        padding: 0px;
        border: 1px solid #aaaaaa;
    }

    .weekend {
        width: 20px !important;
        margin-right: 3px;
    }

        .weekend > textarea {
            display: none;
        }

    .div-table-col-abs {
        float: left; /*fix for  buggy browsers*/
        display: table-column;
        height: 50px;
    }

    .div-table-col-header-abs {
        float: left; /*fix for  buggy browsers*/
        display: table-column;
        height: 50px;
        overflow: hidden;
        margin-left: 1px;
    }

    .highlight {
        background: red;
        width: 20px;
        overflow: hidden;
        color: transparent;
    }

    .USNumber {
        font-weight: bold;
        padding: 0px;
    }

        .USNumber a {
            padding-left: 20px;
        }

    .Name {
        font-weight: bold;
    }

    .TaskType {
        text-align: right !important;
    }

        .TaskType > button {
            font-size: 6pt;
            padding: 2px;
            margin: 0px;
        }

    .Estimate {
        text-align: right;
    }

    .whoDoesIt {
    }

    .Story {
    }

    .customInput {
        width: 100%;
    }

    textarea {
        width: 100%;
        height: 95%;
        box-sizing: border-box;
    }

    .dragger {
        border: 1px solid black;
        cursor: move;
        margin-top: 3px;
        margin-bottom: 3px;
    }

        .dragger > * > span {
            vertical-align: top;
            text-align: left;
        }

    .notInIterationAnymore {
        border: 3px dashed red;
    }

    .tallyName {
        text-align: left;
        float: left;
        margin-left: 2px;
    }

    .tallyEst {
        text-align: right;
        font-weight: bold;
        float: right;
        margin-right: 2px;
    }

    ul.userstoryfilter {
        padding-left: 15px;
        margin-left: 3px;
    }

    ul.standardTasks {
        padding-left: 15px;
        margin-left: 3px;
    }

    .standardTasks > li {
        list-style-type: circle;
    }

    li > button {
        width: 10px;
        height: 10px;
        padding: 0;
        vertical-align: top;
        line-height: 0;
        box-sizing: border-box;
    }

    li.listitemstory:hover {
        cursor: pointer;
    }

    .filterByName {
        cursor: pointer;
        margin-left: -25px;
        display: block;
    }

        .filterByName > div {
            display: inline;
        }

    .filtered {
        font-weight: bolder;
    }

        .filtered > span {
            font-weight: bolder;
        }

    .hidden {
        display: none !important;
    }

    .cardboard {
        margin-bottom: 0;
        border: 1px solid #C6C6C6;
        background-color: #F4F7F8;
        border-collapse: collapse;
        /*table-layout: fixed;*/
        width: 100%;
    }

        .cardboard.Completed .Name {
            text-decoration: line-through;
        }

        .cardboard.In-Progress .Name {
            color: red;
        }

    .cardheader {
        background-color: #B2E3B6;
    }

    .cardboard.cardheader {
        border-bottom: 1px solid #C6C6C6;
    }

    .parentStory {
        border-top: 1px solid #C6C6C6;
    }

    .cardWhoDoesIt {
    }

    .cardOwner {
        text-align: right;
        width: 20px !important;
    }

    .customEstimateValue {
        display: none;
    }

    .icon {
        background-image: url(/slm/images/rally/sprites/harmonized_chicklet_sprites.png);
        height: 20px;
        width: 20px;
        position: absolute;
    }

        .icon.Defect {
            background-position: 0 60;
        }

        .icon.HierarchicalRequirement {
            background-position: 103 60;
        }
</style>

<body style="margin: 0px; margin-top: 5px; height: 100%;">
    <div style="float: right; text-align: right; padding-bottom: 5px; width: 100%; margin: 5px;">
        <div style="position: absolute; text-align: left; margin-left: 20px;" id="iterationMessages">
            &nbsp;
        </div>

        <div style="float: right; text-align: right; width: 100%;">
            <span id="Messages" style="display: none;">Loading...</span>
            <span>
                Task Status:
                <input checked="checked" type="checkbox" name="Chk_CustomStateTask_Defined" value="Defined" onclick="javascript: app.FilterTasksByState(this, 'Defined')" />
                <label for="Chk_CustomStateTask_Defined">Defined</label>
                <input checked="checked" type="checkbox" name="Chk_CustomStateTask_In-Progress" value="In-Progress" onclick="javascript: app.FilterTasksByState(this, 'In-Progress')" />
                <label for="Chk_CustomStateTask_In-Progress">In-Progress</label>
                <input checked="checked" type="checkbox" name="Chk_CustomStateTask_Completed" value="Completed" onclick="javascript: app.FilterTasksByState(this, 'Completed')" />
                <label for="Chk_CustomStateTask_Completed">Completed</label>
            </span>
            <button onclick="javascript: app.Refresh();" class="btn">
                Refresh
            </button>
            <button onclick="javascript: app.SaveIt();" class="btn">
                Save
            </button>
            <button onclick="javascript: app.Reset();" class="btn">
                Reset
            </button>
            <button onclick="javascript: app.PrintIt();" class="btn">
                Print
            </button>
        </div>
    </div>

    <div style="width: 100%;">
        <div style="width: 90%; float: left; margin:0 auto;">
            <div id="tblCalender" style="width: 100%;" class="div-table">
                Loading...
            </div>
            <div style="width: 200px; margin-top: 20px;">
                <span style="font-weight: bold;">Team Estimates</span>
                <ul id="overallTally"></ul>
            </div>
        </div>
        <div id="userStoryFilter" style="width: 10%; float: right; height: 100%;">
            <div style="border-bottom: 1px solid black; margin: 3px;">Iteration Story Filter</div>
            <ul class="userstoryfilter"></ul>
            <ul class="standardTasks"></ul>
        </div>
    </div>
</body>

<footer>
    <script type="text/template" id="calendarTemplate">
        <!-- Calendar Template -->
        <div class="div-table-row">Absentees/Notes</div>
        <div id="absentees" class="div-table-row">&nbsp;</div>
        <div class="div-table-row">Click on the day header to mark as a holiday</div>
        <div id="holidays" data-name="holidays" class="div-table-row">&nbsp;</div>
        <div id="morning" data-name="morning" class="div-table-row">&nbsp;</div>
        <div id="lunch" data-name="lunch" class="div-table-row">&nbsp;</div>
        <div id="afternoon" data-name="afternoon" class="div-table-row">&nbsp;</div>
        <div id="tally" data-name="tally" class="div-table-row"></div>
    </script>

    <script type="text/template" id="absenteesTemplate">
        <!-- Absentees Template -->
        <div class='div-table-col-header-abs col'>
            <textarea></textarea>
        </div>
    </script>

    <script type="text/template" id="holidaysTemplate">
        <!-- Holidays Template -->
        <div class='div-table-col-header col' title='Click to mark as a holiday' data-date=''>
            &nbsp;
        </div>
    </script>

    <script type="text/template" id="tallyTableTemplate">
        <!-- Tally Table Template -->
        <div class='div-table-col-tally col' title='Task estimate per team member per day'>
            <div style="width: 100%; min-height: 12px; border-bottom: 1px solid #666666; padding-bottom: 4px;">
                <span style="float: left;  margin: 2px;">
                    Name
                </span>
                <span style="float: right; margin: 2px;">
                    Total
                </span>
            </div>
            <div class="data">
                &nbsp;
            </div>
        </div>
    </script>

    <script type="text/template" id="tallyTemplate">
        <!-- Tally Template -->
        <div style="width: 100%; min-height: 12px; text-align: left; margin: 0px;">
            <span class="tallyName">&nbsp;</span>
            <span class="tallyEst">&nbsp;</span>
        </div>
    </script>

    <script type="text/template" id="workTemplate">
        <!-- Work Template -->
        <div class='div-table-col col' ondrop='drop(event)' ondragover='allowDrop(event)'>
            &nbsp;
        </div>
    </script>

    <script type="text/template" id="taskTemplate">
        <!-- Task Template -->
        <div class='dragger cardboard' draggable="true" ondragstart="drag(event)">
            <table class="cardboard">
                <thead class="cardheader">
                    <tr>
                        <td class="USNumber" colspan="2">
                            &nbsp;
                        </td>
                        <td class="TaskType">
                            <button onclick="app.RemoveTask(this)" title="Remove from plan. Refreshing will bring it back.">X</button>
                        </td>
                    </tr>
                </thead>
                <tbody>
                    <tr class="cardWhoDoesIt">
                        <td>
                            Est:
                            <span class="Estimate">
                                &nbsp;
                            </span>
                        </td>
                        <td class="whoDoesIt">
                            ?
                        </td>
                        <td class="cardOwner">
                            <img data-url="https://rally1.rallydev.com/slm/profile/viewThumbnailImage.sp?tSize=20&amp;uid=" />
                        </td>
                    </tr>
                    <tr>
                        <td class="Name" colspan="3">
                            &nbsp;
                        </td>
                    </tr>
                    <tr class="parentStory">
                        <td colspan="3">
                            Parent:<br />
                            <span class="Story">
                                &nbsp;
                            </span>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </script>

    <script type="text/template" id="storyTemplate">
        <!-- Story Template -->
        <li class="listitemstory">
            <span></span>
            <button title="Add tasks">+</button>
        </li>
    </script>

    <script type="text/template" id="discussionTemplate">
        <!-- Discussion Template -->
        <p>
            <a id="note" href='' target='_blank'>Iteration planning note:</a>
        </p>
        <p>
            This task has been planned, as part of '<a id="iteration" href='https://rally1.rallydev.com/#/teamplan' target='_blank'></a>' to be completed <span id="time" style="font-weight:bold;"></span> on <span id="date" style="font-weight:bold;"></span>.
        </p>
        <p>
            The task has been estimated at <span id="estimate" style="font-weight:bold;"></span> and assigned to <span id="assignedto" style="font-weight:bold;"></span>.
        </p>
    </script>
</footer>

<script>

    var RALLY = window.parent.RALLY;
    var Ext = window.parent.Ext4 || window.parent.Ext;

    var weekday = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
    var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    Date.prototype.addDays = function (days) {
        var date = new Date(this.valueOf());
        date.setDate(date.getDate() + days);
        return date;
    };
    Date.prototype.businessDaysTill = function (endDate) {
        var startDate = new Date(this.valueOf());
        var count = 0;
        var curDate = startDate;
        while (curDate <= endDate) {
            var dayOfWeek = curDate.getDay();
            var isWeekend = (dayOfWeek == 6) || (dayOfWeek == 0);
            if (!isWeekend)
                count++;
            curDate = curDate.addDays(1);
        }
        return count;
    };
    Date.prototype.DaysDifferenceBetween = function (second) {
        var first = new Date(this.valueOf());
        return Math.round((second - first) / (1000 * 60 * 60 * 24));
    }
    Date.prototype.IsWeekend = function () {
        var myDate = new Date(this.valueOf());
        var dayOfWeek = myDate.getDay();
        return (dayOfWeek == 6) || (dayOfWeek == 0); // sat or sun
    }

    String.prototype.format = function () {
        var theString = arguments[0];
        for (var i = 1; i < arguments.length; i++) {
            var regEx = new RegExp("\\{" + (i - 1) + "\\}", "gm");
            theString = theString.replace(regEx, arguments[i]);
        }
        return theString;
    }
    String.prototype.encode = function () {
        var str = this.valueOf();
        return window.btoa(str);;
        //return btoa(encodeURIComponent(str).replace(/%([0-9A-F]{2})/g, function (match, p1) {
        //  return String.fromCharCode('0x' + p1);
        //}));
    }
    String.prototype.decode = function () {
        var str = this.valueOf();
        return window.atob(str);;
    }

    $.fn.classes = function (callback) {
        var classes = [];
        $.each(this, function (i, v) {
            var splitClassName = v.className.split(/\s+/);
            for (var j in splitClassName) {
                var className = splitClassName[j];
                if (-1 === classes.indexOf(className)) {
                    classes.push(className);
                }
            }
        });
        if ('function' === typeof callback) {
            for (var i in classes) {
                callback(classes[i]);
            }
        }
        return $(classes);
    };

    $.fn.extend({
        refresh: function () {
            var $parent = this.end();
            if ($parent.length == 0) {
                if (this.parent()) { $parent = this.parent(); }
                else { $parent = $("document"); }
            }
            var selector = this.selector.substring($parent.selector.length).trim();
            return $parent.find(selector);
        }
    });

    function allowDrop(ev) {
        ev.preventDefault();
    }

    function drag(ev) {
        ev.dataTransfer.setData("text", ev.target.id);
        dragstop = true;
        try {
            if (ev.originalEvent.clientY < 150) {
                dragstop = false;
                scroll(-1)
            }
            if (ev.originalEvent.clientY > ($(window).height() - 150)) {
                dragstop = false;
                scroll(1)
            }
        } catch (e) {
            dragstop = false;
        }
    }

    function scroll(step) {
        var scrollY = $(window.parent.window).scrollTop();
        $(window.parent.window).scrollTop(scrollY + step);
        if (!stop) {
            setTimeout(function () { scroll(step) }, 20);
        }
    }

    function drop(ev) {
        ev.preventDefault();
        var data = ev.dataTransfer.getData("text");
        $(ev.target).closest(".div-table-col").append($(document.getElementById(data)));
        if (app) {
            app.afterDrop(ev);
        }
    }

    var app = new (function () {

        self = this,

        this.isLoading = false,
        this.currentIterationId = "",
        this.currentIterationName = "",
        this.templatesLoaded = false,
        this.lastStoryFilter = null,
        this.lastUserFilter = null,

        this.$absenteesTemplate = null,
        this.$holidaysTemplate = null,
        this.$workTemplate = null,
        this.$calendarTemplate = null,
        this.$taskTemplate = null,
        this.$tallyTemplate = null,
        this.$tallyTableTemplate = null,
        this.$storyTemplate = null,
        this.$discussionTemplate = null,

        this.lastResize = null,
        this.interval = null,

        this.onDashboardIterationChanged = function (iteration) {
            if (!self.templatesLoaded) {
                self._LoadTemplates();
            }

            self._loadIterationDetails(RALLY.activePage.context.timeboxFilter.iteration);

            self.ResizeColumnWidths();
        },

        this.afterDrop = function (event) {
            self.lastResize = null;
            self.CalculateTallies();
        },

        this._resetResizeInterval = function () {

            if (self.interval) {
                clearInterval(self.interval);
            }

            self.interval = setInterval(function () {
                self.ResizeColumnWidths();
            }, 60 * 1000);

            self.lastResize = new Date();
        },

        this.RemoveTask = function (el) {
            $(el).closest('.dragger').remove();
            app.CalculateTallies();
        },

        this.AddCustomTask = function (id, name, duration) {
            var $calendar = $("#tblCalender");

            var $firstMorning = $calendar.find("#morning > .div-table-col").first();

            $details = self.$taskTemplate.clone();
            $details.attr("data-checkedIfExists", "true");
            $details.attr("id", name);
            $details.attr("data-task-id", id);
            $details.attr("data-user-story-id", id);
            $details.attr("data-user-name", "Whole Team");
            $details.css("background-color", "red");
            $details.find("table").first().width("98%");
            $details.find(".USNumber").html(name);
            $details.find(".whoDoesIt").html("Whole Team");
            $details.find(".Estimate").html("<input class='customEstimateInput' style='width: 80%' value='" + duration + "' type='number' min='0.00' max='8.00' step='0.25'><span class='customEstimateValue'>" + duration + "</span>");
            $details.find(".parentStory").empty();

            $firstMorning.append($details);

            setTimeout(function () {
                app.ResizeColumnHeight();
                app.CalculateTallies();
                app.FilterTasksByUserStory(null);
            }, 50);

            return true;
        },

        this._updateRallyIteration = function (input, successfunc) {
            var url = "https://rally1.rallydev.com/slm/webservice/v2.0/iteration/";

            $.getJSON("https://rally1.rallydev.com/slm/webservice/v2.0/security/authorize", function (security) {
                $.ajax({
                    type: 'POST',
                    url: url + self.currentIterationId + "?key=" + security.OperationResult.SecurityToken,
                    data: JSON.stringify(input),
                    success: function (data) {
                        if (successfunc) {
                            successfunc.call(this);
                        }
                    },
                    contentType: "application/json",
                    dataType: 'json'
                });
            });
        },

        this.Reset = function () {
            self._Confirmation("Reset?", "Reset iteration plan? This will delete previously the saved plan and refresh the board.<br/><br/>Note: You may need to log in again with your rally credentials.", function () {
                self._updateRallyIteration({ "Iteration": { "c_PlanDetails": null } }, function (data) {
                    $("#Messages").text("Reset iteration information completed").fadeIn().delay(1000).fadeOut("slow");

                    if (self.currentIterationId) {
                        self._setIterationDetails(self.currentIterationId);
                    }
                });
            }, function () {
                $("#Messages").text("Reset Cancelled.").fadeIn().delay(1000).fadeOut("slow");
            });
        },

        this.Refresh = function (alreadyShowingMessages) {
            if (self.currentIterationId) {
                if (!alreadyShowingMessages || alreadyShowingMessages == false) {
                    $("#Messages").text("Refreshing").fadeIn().delay(1000).fadeOut("slow");
                }
                self._setIterationDetails(self.currentIterationId);
            }

            var $stories = $("#userStoryFilter > .userstoryfilter");
            $stories.empty();

            self._createStandardStorys();
        },

        this.SaveIt = function () {
            self._Confirmation("Save?", "Save iteration plan?<br/><br/>Note: You may need to log in again with your rally credentials.", function () {
                $("#tblCalender").find('textarea').each(function () {
                    $(this).parent().append($("<span style='display: none;' class='hiddentextarea' />").html($(this).val()));
                });

                self._updateRallyIteration({ "Iteration": { "c_PlanDetails": $("#tblCalender").html().encode() } }, function (data) {
                    $("#Messages").text("Saved iteration information.").fadeIn().delay(1000).fadeOut("slow");
                    self._Confirmation("Add discussion notes?", "Do you want to update task discussions with expected completion dates and times? <br/><br/>Note: this may take a little while.", function () {
                        self._AddTaskComments(function () {
                            app.Refresh(true);
                        });
                    }, function () {
                        app.Refresh(true);
                    });
                    if (console && console.log) {
                        if (this.OperationResult && this.OperationResult.Object) {
                            console.log(this.OperationResult.Object.c_PlanDetails);
                        } else {
                            console.log("No plan returned.");
                        }
                    }
                });
            },
            function () {
                $("#Messages").text("Save Cancelled.").fadeIn().delay(1000).fadeOut("slow");
            });
        },

        this._AddTaskComments = function (callback) {

            var $tasksDiv = $("div.cardboard");

            var allTasks = [];
            var msg = Ext.Msg.progress('Saving', 'Adding discussion items...');
            msg.updateProgress(0);
            var totalCount = $tasksDiv.length;

            var url = "https://rally1.rallydev.com/slm/webservice/v2.0/ConversationPost/create";

            $.getJSON("https://rally1.rallydev.com/slm/webservice/v2.0/security/authorize", function (security) {
                $tasksDiv.each(function (i, v) {
                    var $this = $(this);
                    var tskid = $this.data("task-id");
                    var date = $this.data("assigned-date");
                    var day = $this.data("assigned-day");
                    var time = $this.data("assigned-time");
                    var to = $this.data("assigned-to");
                    var est = $this.data("assigned-estimate");

                    var $inputDetails = self.$discussionTemplate.clone();
                    $inputDetails.find("#note").attr("href", window.top.location.href);
                    $inputDetails.find("#iteration").html(RALLY.activePage.context.project.Name + " - " + (self.currentIterationName || "Unscheduled"));
                    $inputDetails.find("#time").html((time == "morning" ? "before lunch" : "before COB"));
                    $inputDetails.find("#date").html(new Date(date).toDateString());
                    $inputDetails.find("#estimate").html((est == "?" ? "an unknown number of hours" : (est == 1 ? "1 hour" : est + " hours")));
                    $inputDetails.find("#assignedto").html(to);

                    var html = $("<div/>").append($inputDetails).html();

                    var input = { "ConversationPost": { "Artifact": tskid, "Text": $("<div/>").append($inputDetails).html() } }

                    $.ajax({
                        type: 'POST',
                        url: url + "?key=" + security.OperationResult.SecurityToken,
                        data: JSON.stringify(input),
                        success: function (data) {
                            url = "https://rally1.rallydev.com/slm/webservice/v2.0/task/";
                            input = { "Task": { "c_DueDate": date } }
                            $.ajax({
                                type: 'POST',
                                url: url + tskid + "?key=" + security.OperationResult.SecurityToken,
                                data: JSON.stringify(input),
                                success: function (data) {
                                    msg.updateProgress((i + 1.00) / totalCount);
                                },
                                contentType: "application/json",
                                dataType: 'json'
                            });
                        },
                        contentType: "application/json",
                        dataType: 'json'
                    });

                }).promise().done(function () {
                    msg.close();
                });
            });
        },

        this._Confirmation = function (title, message, yesCB, noCB) {
            Ext.create('Rally.ui.dialog.ConfirmDialog', {
                title: title,
                message: message,
                listeners: {
                    confirm: function () {
                        if (yesCB) {
                            yesCB.call(this);
                        }
                    },
                    cancel: function () {
                        if (noCB) {
                            noCB.call(this);
                        }
                    }
                }
            });
        },

        this.PrintIt = function () {
            var data = $("#tblCalender").html();
            var mywindow = window.open('', 'my div', 'height=400,width=600');
            mywindow.document.write('<html><head><title>Iteration Plan</title>');
            $(document).find("style").each(function (i, v) {
                mywindow.document.write("<style>" + $(v).html() + "</style>");
            });
            mywindow.document.write('</head><body >');
            mywindow.document.write(data);
            mywindow.document.write('</body></html>');
            mywindow.document.close(); // necessary for IE >= 10
            mywindow.focus(); // necessary for IE >= 10
            mywindow.print();
            mywindow.close();
            return true;
        },

        this._checkIfAllUserStoriesHaveTasks = function (iterationId) {
            setTimeout(function () {

                var url = "https://rally1.rallydev.com/slm/webservice/v2.0/hierarchicalrequirement?fetch=Tasks,Name,ObjectID,FormattedID&start=1&pagesize=200&query=((ScheduleState%20!%3D%20%22Completed%22)%20And%20(Iteration.ObjectId%20%3D%20%22" + iterationId + "%22))";

                var $messages = $("#iterationMessages");
                var $stories = $("#userStoryFilter > .userstoryfilter");

                $.getJSON(url, function (data) {
                    $messages.empty();
                    if (data && data.QueryResult && data.QueryResult.TotalResultCount > 0) {

                        var total = 0;
                        for (var i = 0; i < data.QueryResult.TotalResultCount; i++) {
                            var res = data.QueryResult.Results[i];
                            if (res.Tasks.Count == 0) {
                                total++;
                            }

                            var $story = self.$storyTemplate.clone();
                            $story.find("span").html(res.FormattedID + "-" + res.Name);
                            $story.attr("data-user-story-id", res.ObjectID);
                            $story.find("span").attr("onclick", "javascript:app.FilterTasksByUserStory('" + res.ObjectID + "')");
                            $story.find("button").attr("onclick", "app.AddTasksToStory('" + res.ObjectID + "');");
                            $stories.append($story);
                        }
                        if (total == 1) {
                            $messages.html("<a target='_blank' href='https://rally1.rallydev.com/#/teamplan'>There is " + total + " story included in the iteration that does not have associated tasks.</a>");
                        } else if (total > 1) {
                            $messages.html("<a target='_blank' href='https://rally1.rallydev.com/#/teamplan'>There are " + total + " stories included in the iteration that do not have associated tasks.</a>");
                        }
                    } else {
                        $messages.html("<a target='_blank' href='https://rally1.rallydev.com/#/teamplan'>You may have stories that are completed but the tasks are not - please confirm.</a>");
                    }
                });

            }, 50);
        },

        this.AddTasksToStory = function (ObjectID) {
            var url = "/#/" + RALLY.activePage.context.project.ObjectID + "d/detail/userstory/" + ObjectID + "/tasks";
            window.open(url, "_new" + ObjectID);

            return true;
        },

        this.FilterByAssignedTo = function (name) {
            if (name == "Unassigned") {
                name = "?";
            }

            if (!name || self.lastUserFilter == name) {
                self.lastUserFilter = null;
                $(".dragger").fadeIn("fast", function () {
                    app.ResizeColumnHeight();
                });
                $(".listitemstory").removeClass("filtered");
            } else {

                self.lastStoryFilter = null;
                self.FilterTasksByUserStory(null);

                self.lastUserFilter = name;

                if ($(".dragger:not([data-user-name='" + name + "'])").length > 0) {
                    $.when($(".dragger:not([data-user-name='" + name + "'])").fadeOut()).done(function () {
                        if ($(".dragger[data-user-name='" + name + "']").length > 0) {
                            $(".dragger[data-user-name='" + name + "']").fadeIn("fast", function () {
                                app.ResizeColumnHeight();
                            });
                        } else {
                            app.ResizeColumnHeight();
                        }
                    });
                } else {
                    app.ResizeColumnHeight();
                }

                $(".listitemstory[data-user-name='" + name + "']").addClass("filtered");
                $(".listitemstory:not([data-user-name='" + name + "'])").removeClass("filtered");
            }
        },

        this.FilterTasksByState = function (checkbox, stateName) {
            if (!checkbox.checked) {
                $(".cardboard." + stateName).addClass("hidden");
            } else {
                $(".cardboard." + stateName).removeClass("hidden");
            }
            self.ResizeColumnHeight();
        },

        this.FilterTasksByUserStory = function (userStoryID) {
            if (!userStoryID || self.lastStoryFilter == userStoryID) {
                self.lastStoryFilter = null;
                $(".dragger").fadeIn("fast", function () {
                    app.ResizeColumnHeight();
                });
                $(".listitemstory").removeClass("filtered");
            } else {
                self.lastUserFilter = null;
                self.FilterByAssignedTo();

                self.lastStoryFilter = userStoryID;
                if ($(".dragger:not([data-user-story-id='" + userStoryID + "'])").length > 0) {
                    $.when($(".dragger:not([data-user-story-id='" + userStoryID + "'])").fadeOut()).done(function () {
                        if ($(".dragger[data-user-story-id='" + userStoryID + "']").length > 0) {
                            $(".dragger[data-user-story-id='" + userStoryID + "']").fadeIn("fast", function () {
                                app.ResizeColumnHeight();
                            });
                        } else {
                            app.ResizeColumnHeight();
                        }
                    });
                } else {
                    app.ResizeColumnHeight();
                }

                $(".listitemstory[data-user-story-id='" + userStoryID + "']").addClass("filtered");
                $(".listitemstory:not([data-user-story-id='" + userStoryID + "'])").removeClass("filtered");
            }
        },

        this._retrievePlan = function (iterationId, successFunc) {
            var url = "https://rally1.rallydev.com/slm/webservice/v2.0/task?fetch=true&start=1&pagesize=200&query=((State%20!%3D%20%22Completed%22)%20And%20(Iteration.ObjectId%20%3D%20%22" + iterationId + "%22))";
            url = "https://rally1.rallydev.com/slm/webservice/v2.0/task?fetch=true&start=1&pagesize=200&query=(Iteration.ObjectId%20%3D%20%22" + iterationId + "%22)";

            self._checkIfAllUserStoriesHaveTasks(iterationId);

            var $calendar = $("#tblCalender");

            var $firstMorning = $calendar.find("#morning > .div-table-col").first();

            $.getJSON(url, function (data) {
                if (data && data.QueryResult && data.QueryResult.TotalResultCount > 0) {

                    var fresh = $(".dragger").length == 0;

                    for (i = 0; i < data.QueryResult.TotalResultCount; i++) {
                        var res = data.QueryResult.Results[i];

                        var usObjectId = res.WorkProduct._ref.substring(res.WorkProduct._ref.lastIndexOf("/") + 1);

                        var existing = false;
                        var $details = $("#" + res._refObjectUUID + ".dragger");
                        if ($details && $details.length > 0) {
                            existing = true;
                            $details.html(self.$taskTemplate.clone().html());
                        }
                        else {
                            $details = self.$taskTemplate.clone();
                        }
                        $details.attr("data-checkedIfExists", "true");
                        $details.attr("id", res._refObjectUUID);
                        $details.attr("data-task-id", res.ObjectID);
                        $details.attr("data-user-story-id", usObjectId);
                        if (res.DisplayColor) {
                            $details.css("background-color", res.DisplayColor);
                            $details.find("table").first().width("98%");
                        }
                        $details.find(".USNumber").html("<span class='icon " + res.WorkProduct._type + "'></span><a target='_blank' href='https://rally1.rallydev.com/#/detail/task/" + res.ObjectID + "'>" + res.FormattedID + "</a>");
                        if (res.Owner && res.Owner._refObjectName) {
                            $details.attr("data-user-name", res.Owner._refObjectName);
                            $details.find(".whoDoesIt").html(res.Owner._refObjectName);
                            var cardownerimage = $details.find(".cardOwner > img").attr("data-url");
                            if (cardownerimage) {
                                cardownerimage += res.Owner._ref.substring(res.Owner._ref.lastIndexOf("/") + 1);
                            }
                            if (cardownerimage) {
                                $details.find(".cardOwner > img").attr("src", cardownerimage);
                            }
                        } else {
                            $details.attr("data-user-name", "?");
                        }
                        $details.find(".Story").html("<a target='_blank' href='https://rally1.rallydev.com/#/detail/userstory/" + usObjectId + "'>" + res.WorkProduct._refObjectName + "</a>");
                        $details.addClass(res.State);
                        $details.find(".Name").html(res.Name);
                        $details.find(".Name").attr("title", res.State);
                        if (res.Estimate) {
                            $details.find(".Estimate").html(res.Estimate);
                        } else {
                            $details.find(".Estimate").html("<b style='color: red;'>?</b>");
                        }

                        if (!existing) {
                            $firstMorning.append($details);
                        }
                    }

                    if (!fresh) {
                        $(".dragger:not([data-checkedIfExists])").addClass("notInIterationAnymore");
                    }
                }

                if (successFunc) {
                    successFunc.call(data);
                }
            });
        },

        this._setTitle = function (iterationName) {
            $(window.parent.document)
                .find(".title")
                .css("font-size", "24pt")
                .html(RALLY.activePage.context.project.Name + " - " + (iterationName || "Unscheduled"));
        },

        this._LoadTemplates = function () {
            if ($("#absenteesTemplate").length == 0) {
                throw new DOMException("Missing Template");
            }
            self.$absenteesTemplate = $($("#absenteesTemplate").html());

            if ($("#holidaysTemplate").length == 0) {
                throw new DOMException("Missing Template");
            }
            self.$holidaysTemplate = $($("#holidaysTemplate").html());

            if ($("#workTemplate").length == 0) {
                throw new DOMException("Missing Template");
            }
            self.$workTemplate = $($("#workTemplate").html());

            if ($("#calendarTemplate").length == 0) {
                throw new DOMException("Missing Template");
            }
            self.$calendarTemplate = $($("#calendarTemplate").html());

            if ($("#taskTemplate").length == 0) {
                throw new DOMException("Missing Template");
            }
            self.$taskTemplate = $($("#taskTemplate").html());

            if ($("#tallyTemplate").length == 0) {
                throw new DOMException("Missing Template");
            }
            self.$tallyTemplate = $($("#tallyTemplate").html());

            if ($("#tallyTableTemplate").length == 0) {
                throw new DOMException("Missing Template");
            }
            self.$tallyTableTemplate = $($("#tallyTableTemplate").html());

            if ($("#storyTemplate").length == 0) {
                throw new DOMException("Missing Template");
            }
            self.$storyTemplate = $($("#storyTemplate").html());

            if ($("#discussionTemplate").length == 0) {
                throw new DOMException("Missing Template");
            }
            self.$discussionTemplate = $($("#discussionTemplate").html());
        },

        this._loadIterationDetails = function (iteration) {
            self.isLoading = true;
            self.currentIterationId = iteration.ObjectID;
            self.currentIterationName = iteration.Name;
            self._setTitle(iteration.Name);
            self._setIterationDetails(iteration.ObjectID);

            var $stories = $("#userStoryFilter > .userstoryfilter");
            $stories.empty();

            self._createStandardStorys();

            setTimeout(function () {
                self._retrievePlan(iteration.Name);
                self.ResizeColumnWidths();
                self.isLoading = false;
            }, 3000);
        },

        this._setIterationDetails = function (objectId) {
            var url = "https://rally1.rallydev.com/slm/webservice/v2.x/Iteration?fetch=true&includePermissions=true&query=(ObjectId = \"" + objectId + "\")";

            var $title = $(window.parent.document).find(".title");

            if (!objectId) {
                var details = "";
                if ($title.parent().parent().find(".moreDetails").length == 0) {
                    details = $("<div class='moreDetails' style='padding: 5px;'>Loading...</div>").insertBefore($title.parent());
                } else {
                    details = $title.parent().parent().find(".moreDetails");
                }
                details.empty().append("<span style='padding: 5px'>Iteration: <b>Unscheduled.</b>");
            } else {
                $.getJSON(url, function (data) {
                    if (data && data.QueryResult && data.QueryResult.TotalResultCount == 1) {
                        var res = data.QueryResult.Results[0];

                        var details = "";
                        if ($title.parent().parent().find(".moreDetails").length == 0) {
                            details = $("<div class='moreDetails' style='padding: 5px;'>Loading...</div>").insertBefore($title.parent());
                        } else {
                            details = $title.parent().parent().find(".moreDetails");
                        }

                        details.empty();
                        details.attr("onclick", "window.open('https://rally1.rallydev.com/#/timeboxes');");
                        details.css("cursor", "pointer");

                        if (res.Theme) {
                            details.append("<span style='padding: 5px'>Theme: <b>" + res.Theme + "</b>");
                        }
                        if (res.State) {
                            details.append("<span style='padding: 5px'>State: <b>" + res.State + "</b>");
                        }

                        if (res.StartDate && res.EndDate) {
                            if (new Date(res.StartDate) < new Date() && new Date(res.EndDate) > new Date()) {
                                details.append("<span style='padding: 5px'>Iteration: <b>In progress - " + new Date().businessDaysTill(new Date(res.EndDate)) + " Days remaining.</b>");
                            } else if (new Date(res.EndDate) < new Date()) {
                                details.append("<span style='padding: 5px'>Iteration: <b>Completed.</b>");
                            } else if (new Date(res.StartDate) > new Date()) {
                                details.append("<span style='padding: 5px'>Iteration: <b>Future date.</b>");
                            }
                        }

                        var $calendar = $("#tblCalender");

                        $calendar.html(self.$calendarTemplate).refresh();

                        if (res.c_PlanDetails && res.c_PlanDetails.length > 0) {
                            $calendar.html(res.c_PlanDetails.decode()).refresh();

                            $calendar.find('.hiddentextarea').each(function () {
                                $(this).parent().find("textarea").text($(this).text().trim());
                                $(this).remove();
                            }).refresh();

                            $calendar.find('.dragger').each(function () {
                                $(this).attr("draggable", "true").attr("ondragstart", "drag(event)");
                            });

                            $calendar.find('.div-table-col').each(function () {
                                $(this).attr("ondrop", "drop(event)").attr("ondragover", "allowDrop(event)");
                            });

                            $calendar.find('td[data-colspan]').each(function () {
                                $(this).attr("colspan", $(this).attr('data-colspan'));
                            });

                            $calendar.find('.TaskType').each(function () {
                                $(this).html('<button onclick=\"app.RemoveTask(this)\">X</button>');
                            });
                        } else {
                            self._createCalendar(new Date(res.StartDate), new Date(res.EndDate));
                        }

                        self.ResizeColumnWidths();

                        self._retrievePlan(objectId, function (data) {

                            $(".div-table-col-header").off().click(function () {
                                var th_index = $(this).index();
                                $(".div-table-row").each(function () {
                                    $(this).find('.div-table-col-header-abs').eq(th_index).toggleClass('weekend');
                                    $(this).find('.div-table-col,.div-table-col-holiday').eq(th_index).toggleClass('highlight');
                                    $(this).find('.div-table-col-header,.div-table-col-holiday-header').eq(th_index).toggleClass('highlight');
                                    $(this).find('.div-table-col-tally').eq(th_index).toggleClass('weekend');
                                });

                                self.ResizeColumnWidths();
                            });

                            self.CalculateTallies();
                        });
                    }
                });
            }
        },

        this.ResizeColumnWidths = function () {
            console.log("Start: ResizeColumnWidths" + (new Date()));

            $("#Messages").fadeOut().text("Resizing column widths - please wait").fadeIn();

            setTimeout(function () {

                self._resetResizeInterval();

                if (self.lastResize && self.lastResize - new Date() < 5000) {
                    $("#Messages").fadeOut("slow").text("");
                    console.log("End: ResizeColumnWidths (via return)" + (new Date()));
                    return;
                }

                var $calendar = $("#tblCalender");

                var $holiday = $calendar.find("#holidays");

                var widthofHolidaysColumns = $holiday.find(".col.highlight").length * $holiday.find(".col.highlight").width();
                var newwidth = Math.floor(((Math.floor($("#tblCalender").innerWidth()) - widthofHolidaysColumns) / $holiday.find(".col:not(.highlight)").length) * 0.97) - 2; // just a bit smaller

                $(".col:not(.weekend)").width(newwidth);
                $(".col.weekend").width(20);

                var curWidth = $(".col:not(.highlight)").width();
                if (curWidth < newwidth) {
                    $(".col:not(.highlight)").animate({ 'width': ("+=" + (newwidth - curWidth)) }, "fast");
                } else {
                    $(".col:not(.highlight)").animate({ 'width': ("-=" + (newwidth - curWidth)) }, "fast");
                }

                $(".col.highlight").animate({ 'width': 20 }, "fast");

                $("#Messages").fadeOut("slow").text("");
                console.log("End: ResizeColumnWidths" + (new Date()));

            }, 50);
        },

        this.ResizeColumnHeight = function () {
            $("#Messages").fadeOut().text("Resizing column heights - please wait").fadeIn();
            console.log("Start: ResizeColumnHeight" + (new Date()));

            setTimeout(function () {

                var $calendar = $("#tblCalender");

                var $morning = $calendar.find("#morning");
                var $lunch = $calendar.find("#lunch");
                var $afternoon = $calendar.find("#afternoon");

                $morning.find('.div-table-col').height("auto").refresh().height(Math.max.apply(null, $morning.find('.div-table-col').map(function () {
                    return $(this).height();
                }).get()));

                $lunch.find('.div-table-col').height("auto").refresh().height(Math.max.apply(null, $lunch.find('.div-table-col').map(function () {
                    return $(this).height();
                }).get()));

                $afternoon.find('.div-table-col').height("auto").refresh().height(Math.max.apply(null, $afternoon.find('.div-table-col').map(function () {
                    return $(this).height();
                }).get()));

                $("#Messages").fadeOut("slow").text("");
                console.log("End: ResizeColumnHeight" + (new Date()));

            }, 50);
        }

        this.CalculateTallies = function () {
            setTimeout(function () {
                var $calendar = $("#tblCalender");

                var $overall = $("#overallTally");

                self.ResizeColumnHeight();

                var tallies = {};

                var daysCount = $calendar.find("#tally > .div-table-col-tally").length;

                $calendar.refresh().find('.dragger').each(function () {
                    var name = $(this).find(".whoDoesIt").text().trim();
                    if (name == "" || name == "?") {
                        name = "Unassigned";
                    }
                    if (!tallies[name]) {
                        tallies[name] = {};
                        tallies[name]["Estimates"] = new Array(daysCount).fill(0);
                        tallies[name]["Overall"] = 0;
                    }

                    var est = parseFloat($(this).find(".Estimate").text());
                    var day = $(this).closest(".div-table-row").find(".div-table-col").index($(this).closest(".div-table-col"));
                    var timeofday = $(this).closest(".div-table-row").data("name");
                    var date = $(".div-table-col-header:eq(" + day + ")").data("date");
                    $(this).attr("data-assigned-date", date);
                    $(this).attr("data-assigned-day", day);
                    $(this).attr("data-assigned-time", timeofday);
                    $(this).attr("data-assigned-to", name);

                    if (isNaN(est)) {
                        tallies[name].Overall = "?";
                        $(this).attr("data-assigned-estimate", "?");
                    } else {
                        $(this).attr("data-assigned-estimate", est);

                        tallies[name].Estimates[day] += est;
                        if (!isNaN(tallies[name].Overall)) {
                            tallies[name].Overall += est;
                        }
                    }
                });

                $overall.empty();
                $.each(tallies, function (name, person) {
                    var $temp = self.$tallyTemplate.clone(true, true);

                    var $t = $("<li />").append($("<span style='width: 100%; float: right;'/>").html($temp.closest("div").html())); //.replaceWith(function () { return "<li>" + this.innerHTML + "</li>"; });
                    $t.addClass("filterByName").addClass("listitemstory");
                    $t.attr("data-user-name", name);
                    $t.find(".tallyName").html(name);
                    if (!isNaN(person.Overall)) {
                        $t.find(".tallyEst").html(person.Overall);
                    } else {
                        $t.find(".tallyEst").html("?");
                    }
                    $overall.append($t);
                });

                for (var i = 0; i < daysCount; i++) {
                    var $tally = $calendar.find(".div-table-col-tally:eq(" + i + ")").find(".data");
                    $tally.empty();
                    $.each(tallies, function (name, person) {
                        if (person.Estimates[i] > 0) {
                            var $t = self.$tallyTemplate.clone();
                            $t.find(".tallyName").html(name);
                            $t.find(".tallyEst").html(person.Estimates[i]);
                            $tally.append($t);
                        }
                    });
                }

                // wire up all the custom tasks again
                $calendar.find(".customEstimateInput").off().change(function () {
                    $(this).parent().find(".customEstimateValue").text($(this).val());
                    $(this).attr('value', $(this).val());
                    app.CalculateTallies();
                });

                $("#overallTally").find(".filterByName").off().click(function () {
                    var name = $(this).find(".tallyName").text().trim();
                    app.FilterByAssignedTo(name);
                });

            }, 50);
        },

        this._createCalendar = function (startDate, endDate) {
            var daysCount = startDate.DaysDifferenceBetween(endDate);

            var $calendar = $("#tblCalender");

            var $holidays = $calendar.find("#holidays");
            var $absentees = $calendar.find("#absentees");
            var $morning = $calendar.find("#morning");
            var $lunch = $calendar.find("#lunch");
            var $afternoon = $calendar.find("#afternoon");
            var $tally = $calendar.find("#tally");

            $holidays.empty();
            $absentees.empty();
            $morning.empty();
            $lunch.empty();
            $afternoon.empty();
            $tally.empty();

            for (var i = 0; i < daysCount; i++) {
                var myDate = new Date();
                myDate.setDate(startDate.getDate() + i);

                var $hd = self.$holidaysTemplate.clone().html(weekday[myDate.getDay()] + "<br/>" + myDate.getDate() + "/" + months[myDate.getMonth()]);
                $hd.attr("data-date", myDate.toISOString());

                var $ab = self.$absenteesTemplate.clone();
                var $m = self.$workTemplate.clone();
                var $l = self.$workTemplate.clone();
                var $a = self.$workTemplate.clone();
                var $t = self.$tallyTableTemplate.clone();

                if (myDate.IsWeekend()) {
                    $hd.toggleClass('highlight');
                    $ab.toggleClass('weekend');
                    $m.toggleClass('highlight');
                    $l.toggleClass('highlight');
                    $a.toggleClass('highlight');
                    $t.toggleClass('weekend');
                }

                $holidays.append($hd);
                $absentees.append($ab);
                $morning.append($m);
                $lunch.append($l);
                $afternoon.append($a);
                $tally.append($t);
            }
        },

        this._createStandardStory = function (name, id, time) {
            var $story = self.$storyTemplate.clone();
            $story.find("span").html(name);
            $story.attr("data-user-story-id", id);
            $story.find("span").attr("onclick", "javascript:app.FilterTasksByUserStory('" + id + "')");
            $story.find("button").attr("onclick", "app.AddCustomTask('" + id + "', '" + name + "', " + time + ");");
            return $story;
        },

        this._createStandardStorys = function () {
            $("#userStoryFilter > .standardTasks")
                .empty()
                .append(self._createStandardStory("Standup", "CustomTask_Standup", 0.25))
                .append(self._createStandardStory("Showcase", "CustomTask_Showcase", 1.00))
                .append(self._createStandardStory("Planning", "CustomTask_Planning", 2.00))
                .append(self._createStandardStory("Backlog Management", "CustomTask_Backlog", 2.00))
                .append(self._createStandardStory("Retrospective", "CustomTask_Retro", 1.00))
                .append(self._createStandardStory("Training", "CustomTask_Training", 1.00));
        }
    })();

    function onDashboardPageTimeboxFilterChanged(args) {
        if (args.iteration) {
            var iteration = args.iteration;
            if (app) {
                app.onDashboardIterationChanged(iteration);;
            }
        }
    }

    rally.addOnLoad(function () {
        $("#appHeader").remove();
        if (app) {
            app.onDashboardIterationChanged(RALLY.activePage.context.timeboxFilter.iteration);
        }
    });

</script>
